<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bank of Taiwanï½œå¹´çµ‚å°¾ç‰™æŠ½ç</title>
  <style>
    :root {
      --brand: #9A0036;
      /* ä¸»è‰²ï¼šç´… */
      --accent: #D6A33A;
      /* å¼·èª¿ï¼šé‡‘ */
      --pink: #EEBAC0;
      /* è¼”åŠ©ï¼šç²‰ */
      --magenta: #941C61;
      /* è¼”åŠ©ï¼šç´«ç´… */
      --bg: #ffffff;
      /* ç™½ */
      --split: #F5F5F5;
      /* æ·ºç° */
      --text: #333333;
      /* æ·±ç°æ–‡å­— */
      --glass: rgba(255, 255, 255, .22);
      --shadow: 0 20px 50px rgba(0, 0, 0, .18);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
        "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(154, 0, 54, .10), transparent 60%),
        radial-gradient(900px 500px at 100% 20%, rgba(148, 28, 97, .10), transparent 55%),
        linear-gradient(180deg, #fff, #fff);
      overflow-x: hidden;
    }

    /* Header */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, .75);
      border-bottom: 1px solid rgba(0, 0, 0, .06);
    }

    .topbar-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .logo-img {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      object-fit: cover;
      box-shadow: 0 10px 25px rgba(154, 0, 54, .25);
      border: 1px solid rgba(255, 255, 255, .35);
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, .45), transparent 45%),
        linear-gradient(135deg, var(--brand), var(--magenta));
      box-shadow: 0 10px 25px rgba(154, 0, 54, .25);
      border: 1px solid rgba(255, 255, 255, .35);
      position: relative;
      overflow: hidden;
    }

    .logo:after {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 0deg, rgba(214, 163, 58, .0), rgba(214, 163, 58, .55), rgba(214, 163, 58, .0));
      animation: shine 3.2s linear infinite;
      transform: rotate(18deg);
      opacity: .9;
    }

    @keyframes shine {
      to {
        transform: rotate(378deg);
      }
    }

    .brand h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .brand small {
      display: block;
      color: rgba(51, 51, 51, .72);
      font-size: 12px;
      margin-top: 2px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--split);
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: 12px;
      padding: 8px 10px;
    }

    .chip label {
      font-size: 12px;
      color: rgba(51, 51, 51, .75);
    }

    .chip input {
      width: 88px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, .10);
      background: #fff;
      outline: none;
      font-weight: 700;
      color: var(--text);
    }

    .chip input:focus {
      border-color: rgba(154, 0, 54, .35);
      box-shadow: 0 0 0 4px rgba(154, 0, 54, .10);
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 14px;
      padding: 12px 16px;
      font-weight: 800;
      letter-spacing: .2px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 14px 28px rgba(0, 0, 0, .12);
      transform: translateZ(0);
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease, opacity .15s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:active {
      transform: translateY(1px) scale(.99);
    }

    .btn-primary {
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, .35), transparent 40%),
        linear-gradient(135deg, var(--accent), #f1c15b 35%, var(--brand));
      color: #fff;
      text-shadow: 0 1px 0 rgba(0, 0, 0, .2);
      border: 1px solid rgba(255, 255, 255, .22);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--magenta), var(--brand));
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .18);
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Layout */
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
      padding-bottom: 88px;
      /* footer space */
    }

    .hero {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
    }

    @media (max-width: 980px) {
      .hero {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(255, 255, 255, .72);
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 16px 10px 16px;
      background: linear-gradient(180deg, rgba(245, 245, 245, .85), rgba(255, 255, 255, 0));
      border-bottom: 1px solid rgba(0, 0, 0, .06);
    }

    .panel-header h2 {
      margin: 0;
      font-size: 15px;
      letter-spacing: .2px;
    }

    .panel-header p {
      margin: 8px 0 0;
      font-size: 12.5px;
      color: rgba(51, 51, 51, .72);
      line-height: 1.6;
    }

    .panel-body {
      padding: 16px;
    }

    /* Result numbers strip (top) */
    .result-strip {
      min-height: 74px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 12px 16px 16px 16px;
    }

    .result-strip .hint {
      color: rgba(51, 51, 51, .65);
      font-size: 13px;
    }

    .num-pill {
      min-width: 88px;
      height: 58px;
      padding: 0 14px;
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 13px;
      line-height: 1.3;
      color: #fff;
      background:
        radial-gradient(circle at 30% 25%, rgba(255, 255, 255, .35), transparent 45%),
        linear-gradient(135deg, var(--brand), var(--magenta));
      border: 1px solid rgba(255, 255, 255, .25);
      box-shadow: 0 18px 35px rgba(154, 0, 54, .25);
      position: relative;
      overflow: hidden;
      animation: pop .55s ease both;
      text-align: center;
    }

    .num-pill:after {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 0deg, rgba(214, 163, 58, 0), rgba(214, 163, 58, .70), rgba(214, 163, 58, 0));
      filter: blur(0.2px);
      animation: sweep 1.2s linear infinite;
      opacity: .75;
      pointer-events: none;
    }

    @keyframes pop {
      0% {
        transform: translateY(10px) scale(.7);
        opacity: 0;
        filter: blur(2px);
      }

      60% {
        transform: translateY(-2px) scale(1.05);
        opacity: 1;
        filter: blur(0);
      }

      100% {
        transform: translateY(0) scale(1);
      }
    }

    @keyframes sweep {
      to {
        transform: rotate(360deg);
      }
    }

    /* Lottery Machine */
    .machine {
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
      padding: 16px;
    }

    .machine-title {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .machine-title h3 {
      margin: 0;
      font-size: 14px;
      letter-spacing: .2px;
    }

    .status {
      font-size: 12px;
      color: rgba(51, 51, 51, .70);
      line-height: 1.6;
      margin-top: 6px;
    }

    .stage {
      position: relative;
      min-height: 360px;
      border-radius: 18px;
      background:
        radial-gradient(900px 360px at 50% 30%, rgba(238, 186, 192, .30), transparent 60%),
        radial-gradient(700px 300px at 30% 70%, rgba(154, 0, 54, .12), transparent 60%),
        linear-gradient(180deg, rgba(245, 245, 245, .9), rgba(255, 255, 255, .9));
      border: 1px solid rgba(0, 0, 0, .06);
      overflow: hidden;
    }

    /* Confetti sparkles */
    .spark {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 2px;
      background: var(--accent);
      opacity: 0;
      transform: translate(-50%, -50%) rotate(0deg);
      pointer-events: none;
    }

    .spark.show {
      animation: spark 900ms ease-out both;
    }

    @keyframes spark {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(.4) rotate(0deg);
        filter: blur(1px);
      }

      15% {
        opacity: 1;
      }

      100% {
        opacity: 0;
        transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.2) rotate(220deg);
        filter: blur(0);
      }
    }

    /* Glass sphere */
    .sphere-wrap {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 16px;
    }

    .sphere {
      width: min(330px, 80vw);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      position: relative;
      background:
        radial-gradient(circle at 28% 22%, rgba(255, 255, 255, .70), rgba(255, 255, 255, .18) 35%, rgba(255, 255, 255, .07) 55%, rgba(255, 255, 255, .0) 72%),
        radial-gradient(circle at 60% 70%, rgba(154, 0, 54, .16), rgba(148, 28, 97, .10) 38%, rgba(0, 0, 0, .0) 72%),
        linear-gradient(135deg, rgba(255, 255, 255, .20), rgba(255, 255, 255, .02));
      border: 1px solid rgba(255, 255, 255, .55);
      box-shadow:
        0 30px 70px rgba(0, 0, 0, .18),
        inset 0 0 0 1px rgba(0, 0, 0, .06);
      overflow: hidden;
      backdrop-filter: blur(2px);
    }

    .sphere:before {
      content: "";
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, .55), transparent 55%);
      transform: rotate(15deg);
      opacity: .7;
      pointer-events: none;
    }

    .sphere:after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 50% 100%, rgba(214, 163, 58, .18), transparent 55%),
        radial-gradient(circle at 10% 80%, rgba(238, 186, 192, .22), transparent 50%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    /* Balls */
    .ball {
      position: absolute;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 900;
      color: #fff;
      text-shadow: 0 1px 0 rgba(0, 0, 0, .25);
      background:
        radial-gradient(circle at 28% 22%, rgba(255, 255, 255, .55), transparent 40%),
        linear-gradient(135deg, var(--brand), var(--magenta));
      border: 1px solid rgba(255, 255, 255, .22);
      box-shadow: 0 14px 22px rgba(154, 0, 54, .18);
      user-select: none;
      will-change: transform;
      filter: saturate(1.05);
    }

    .ball.gold {
      background:
        radial-gradient(circle at 28% 22%, rgba(255, 255, 255, .55), transparent 40%),
        linear-gradient(135deg, var(--accent), #f3cc74, var(--brand));
      box-shadow: 0 18px 30px rgba(214, 163, 58, .22);
    }

    /* Output window */
    .output {
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: 16px;
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(255, 255, 255, .72);
      border: 1px solid rgba(0, 0, 0, .06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .output .now {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .output .now b {
      font-size: 13px;
      letter-spacing: .2px;
    }

    .output .now span {
      font-size: 12px;
      color: rgba(51, 51, 51, .7);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .big-number {
      min-width: 120px;
      height: 60px;
      padding: 0 14px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 14px;
      line-height: 1.4;
      color: #fff;
      background:
        radial-gradient(circle at 30% 25%, rgba(255, 255, 255, .35), transparent 45%),
        linear-gradient(135deg, var(--brand), var(--magenta));
      border: 1px solid rgba(255, 255, 255, .25);
      box-shadow: 0 18px 35px rgba(154, 0, 54, .22);
      text-align: center;
    }

    .big-number.pulse {
      animation: pulse 700ms ease both;
    }

    @keyframes pulse {
      0% {
        transform: scale(.88);
        filter: blur(.6px);
        opacity: .0;
      }

      45% {
        transform: scale(1.08);
        filter: blur(0);
        opacity: 1;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Footer */
    footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, .9);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 0, 0, .06);
      padding: 12px 18px;
      z-index: 60;
      font-size: 12px;
      color: rgba(51, 51, 51, .72);
      text-align: center;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <!-- æ”¹ç‚º img æ¨™ç±¤ -->
        <img src="./logo.png" alt="Bank of Taiwan Logo" class="logo-img" />
        <div style="min-width:0">
          <h1>Bank of Taiwanï½œå¹´çµ‚å°¾ç‰™æŠ½ç</h1>
          <small>ç¥æ‚¨ä¸­å¤§ç!</small>
        </div>
      </div>

      <div class="actions">
        <div class="chip">
          <label for="M">åƒèˆ‡äººæ•¸</label>
          <input id="M" type="text" readonly value="0" style="width:68px; cursor:default; background:#f9f9f9;" />
        </div>
        <div class="chip">
          <label for="N">æŠ½å‡ºäººæ•¸ N</label>
          <input id="N" type="number" min="1" max="9999" value="1" />
        </div>

        <label class="btn btn-secondary" for="csvUpload" style="margin:0; cursor:pointer;">
          ğŸ“ ä¸Šå‚³CSV
          <input type="file" id="csvUpload" accept=".csv" style="display:none;" />
        </label>
        <button class="btn btn-secondary" id="btnClear" type="button">æ¸…é™¤è³‡æ–™</button>
        <button class="btn btn-secondary" id="btnReset" type="button">é‡ç½®</button>
        <button class="btn btn-primary" id="btnStart" type="button">é–‹å§‹æŠ½ç</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="panel-header">
        <h2>æŠ½ççµæœï¼ˆä¾åºæ­æ›‰ï¼‰</h2>
        <p>æ¯ä½ä¸­çè€…æœƒåœ¨å‹•ç•«å¾Œé€ä¸€æ­æ›‰ä¸¦é¡¯ç¤ºæ–¼ä¸Šæ–¹ã€‚è«‹å…ˆä¸Šå‚³åŒ…å«ã€Œå“¡å·¥ç·¨è™Ÿã€å’Œã€Œå§“åã€çš„CSVæª”æ¡ˆï¼Œå†è¨­å®šæŠ½å‡ºäººæ•¸ Nã€‚</p>
      </div>
      <div class="result-strip" id="resultStrip">
        <span class="hint">å°šæœªé–‹å§‹ï¼Œè«‹æŒ‰ã€Œé–‹å§‹æŠ½çã€ã€‚</span>
      </div>
    </div>

    <div class="hero">
      <div class="panel">
        <div class="panel-header">
          <h2>æ¨‚é€çƒæ©Ÿï¼ˆé€æ˜çƒé«”ï¼‹æ»¾å‹•æ•ˆæœï¼‰</h2>
          <p>æŒ‰ä¸‹é–‹å§‹å¾Œï¼šå…ˆé€²è¡Œæ»¾å‹•å‹•ç•«ï¼ˆæ¨¡æ“¬é–‹çï¼‰ï¼Œå†é€é¡†æŠ½å‡º N å€‹è™Ÿç¢¼ï¼ˆä¸é‡è¤‡ï¼‰ã€‚</p>
        </div>

        <div class="machine">
          <div class="machine-title">
            <div>
              <h3>é–‹çèˆå°</h3>
              <div class="status" id="statusText">å¾…å‘½ä¸­ï¼šè«‹è¨­å®š Mã€N å¾Œé–‹å§‹ã€‚</div>
            </div>
          </div>

          <div class="stage" id="stage">
            <div class="sphere-wrap">
              <div class="sphere" id="sphere" aria-label="é€æ˜æŠ½ççƒé«”"></div>
            </div>

            <div class="output">
              <div class="now">
                <b>ç›®å‰é–‹å‡ºè™Ÿç¢¼</b>
                <span id="nowHint">â€”</span>
              </div>
              <div class="big-number" id="bigNumber">--</div>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
            <div style="font-size:12.5px; color:rgba(51,51,51,.72); line-height:1.6">
              å°æç¤ºï¼šè‹¥ç¾å ´ç„¡è²éŸ³ï¼Œè«‹ç¢ºèªç€è¦½å™¨å…è¨±ç¶²ç«™æ’­æ”¾éŸ³æ•ˆï¼ˆæŒ‰ä¸‹ã€Œé–‹å§‹æŠ½çã€å¾Œé€šå¸¸å³å¯å•Ÿç”¨ï¼‰ã€‚
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2>è¦å‰‡èˆ‡é¡¯ç¤º</h2>
          <p>æœ¬é ç¤ºç¯„ï¼šå¾ 1..M çš„è™Ÿç¢¼çƒä¸­ï¼Œä¸é‡è¤‡æŠ½å‡º N å€‹ã€‚æ¯é¡†è™Ÿç¢¼éƒ½æœ‰æ­æ›‰ç‰¹æ•ˆèˆ‡æç¤ºéŸ³ã€‚</p>
        </div>
        <div class="panel-body">
          <div style="display:grid; gap:12px;">
            <div
              style="background:var(--split); border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:12px 14px;">
              <div style="font-weight:900; color:var(--brand); margin-bottom:6px;">æŠ½çè¨­å®š</div>
              <ul style="margin:0; padding-left:18px; color:rgba(51,51,51,.78); line-height:1.8;">
                <li><b>CSVæ ¼å¼</b>ï¼šç¬¬ä¸€æ¬„ã€Œå“¡å·¥ç·¨è™Ÿã€ï¼Œç¬¬äºŒæ¬„ã€Œå§“åã€</li>
                <li><b>åƒèˆ‡äººæ•¸</b>ï¼šè‡ªå‹•å¾ä¸Šå‚³çš„CSVè®€å–</li>
                <li><b>N</b>ï¼šè¦æŠ½å‡ºçš„äººæ•¸ï¼ˆä¸é‡è¤‡æŠ½å–ï¼‰</li>
                <li>é™åˆ¶ï¼šN ä¸èƒ½å¤§æ–¼åƒèˆ‡äººæ•¸</li>
              </ul>
            </div>

            <div style="background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:12px 14px;">
              <div style="font-weight:900; color:var(--magenta); margin-bottom:6px;">æµç¨‹</div>
              <ol style="margin:0; padding-left:18px; color:rgba(51,51,51,.78); line-height:1.8;">
                <li>ä¸Šå‚³CSVæª”æ¡ˆï¼ˆè³‡æ–™æœƒå„²å­˜åœ¨ç€è¦½å™¨æœ¬åœ°ï¼‰</li>
                <li>è¨­å®šè¦æŠ½å‡ºçš„äººæ•¸ N</li>
                <li>é»æ“Šã€Œé–‹å§‹æŠ½çã€é€²å…¥æ»¾å‹•å‹•ç•«</li>
                <li>é€ä¸€æ­æ›‰ä¸­çè€…ï¼šé¡¯ç¤ºå“¡å·¥ç·¨è™Ÿèˆ‡å§“åï¼Œæ­é…éŸ³æ•ˆç‰¹æ•ˆ</li>
                <li>å¯é‡è¤‡æŠ½çï¼Œæˆ–ä½¿ç”¨ã€Œæ¸…é™¤è³‡æ–™ã€é‡æ–°ä¸Šå‚³</li>
              </ol>
            </div>

            <div
              style="background:linear-gradient(135deg, rgba(214,163,58,.16), rgba(154,0,54,.08)); border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:12px 14px;">
              <div style="font-weight:900; margin-bottom:6px;">æ³¨æ„</div>
              <div style="color:rgba(51,51,51,.78); line-height:1.8; font-size:13px;">
                è‹¥ç€è¦½å™¨é˜»æ“‹è‡ªå‹•æ’­æ”¾éŸ³æ•ˆï¼Œç¬¬ä¸€æ¬¡è«‹å‹™å¿…ç”±ä½¿ç”¨è€…é»æ“Šã€Œé–‹å§‹æŠ½çã€ä¾†å•Ÿç”¨éŸ³è¨Šã€‚
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- hero end -->
  </div> <!-- wrap end -->

  <footer>ç‰ˆæ¬Šæ‰€æœ‰ï¼š Â© Dunk</footer>

  <script>
    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);

    function clampInt(v, min, max) {
      const n = Math.floor(Number(v));
      if (Number.isNaN(n)) return min;
      return Math.min(max, Math.max(min, n));
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ===== Audio (Web Audio API, no external files) =====
    const SFX = (() => {
      let ctx = null;

      function ensure() {
        if (!ctx) {
          const AC = window.AudioContext || window.webkitAudioContext;
          ctx = new AC();
        }
        return ctx;
      }

      function beep({ freq = 880, dur = 0.08, type = "sine", gain = 0.08, detune = 0 } = {}) {
        const c = ensure();
        const t0 = c.currentTime;

        const o = c.createOscillator();
        const g = c.createGain();

        o.type = type;
        o.frequency.setValueAtTime(freq, t0);
        o.detune.setValueAtTime(detune, t0);

        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

        o.connect(g);
        g.connect(c.destination);

        o.start(t0);
        o.stop(t0 + dur + 0.02);
      }

      function whoosh() {
        // quick filtered noise burst
        const c = ensure();
        const t0 = c.currentTime;

        const bufferSize = 0.12 * c.sampleRate;
        const buffer = c.createBuffer(1, bufferSize, c.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) {
          data[i] = (Math.random() * 2 - 1) * (1 - i / data.length);
        }

        const src = c.createBufferSource();
        src.buffer = buffer;

        const bp = c.createBiquadFilter();
        bp.type = "bandpass";
        bp.frequency.setValueAtTime(900, t0);
        bp.Q.setValueAtTime(0.8, t0);

        const g = c.createGain();
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.12, t0 + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.12);

        src.connect(bp);
        bp.connect(g);
        g.connect(c.destination);

        src.start(t0);
        src.stop(t0 + 0.14);
      }

      function win() {
        // short "jackpot" arpeggio
        beep({ freq: 784, dur: 0.08, type: "triangle", gain: 0.08 });
        setTimeout(() => beep({ freq: 988, dur: 0.10, type: "triangle", gain: 0.09 }), 90);
        setTimeout(() => beep({ freq: 1175, dur: 0.12, type: "triangle", gain: 0.10 }), 190);
        setTimeout(() => beep({ freq: 1568, dur: 0.14, type: "sine", gain: 0.10 }), 320);
      }

      async function resumeIfNeeded() {
        const c = ensure();
        if (c.state === "suspended") await c.resume();
      }

      return { resumeIfNeeded, beep, whoosh, win };
    })();

    // ===== DOM =====
    const elM = $("#M");
    const elN = $("#N");
    const btnStart = $("#btnStart");
    const btnReset = $("#btnReset");
    const btnClear = $("#btnClear");
    const csvUpload = $("#csvUpload");
    const statusText = $("#statusText");
    const resultStrip = $("#resultStrip");
    const sphere = $("#sphere");
    const stage = $("#stage");
    const bigNumber = $("#bigNumber");
    const nowHint = $("#nowHint");

    // ===== LocalStorage Management =====
    const STORAGE_KEY = 'lottery_participants';
    let participants = [];

    function saveParticipants(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      participants = data;
      updateParticipantCount();
    }

    function loadParticipants() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          participants = JSON.parse(stored);
          updateParticipantCount();
          return true;
        } catch (e) {
          console.error('Failed to parse stored participants:', e);
        }
      }
      return false;
    }

    function clearParticipants() {
      localStorage.removeItem(STORAGE_KEY);
      participants = [];
      updateParticipantCount();
    }

    function updateParticipantCount() {
      const count = participants.length;
      elM.value = count;
      if (count === 0) {
        statusText.textContent = 'è«‹å…ˆä¸Šå‚³åŒ…å«ã€Œå“¡å·¥ç·¨è™Ÿã€å’Œã€Œå§“åã€çš„CSVæª”æ¡ˆã€‚';
        btnStart.disabled = true;
      } else {
        statusText.textContent = `å·²è¼‰å…¥ ${count} ä½åƒèˆ‡è€…ï¼Œè«‹è¨­å®šæŠ½å‡ºäººæ•¸å¾Œé–‹å§‹æŠ½çã€‚`;
        btnStart.disabled = false;
      }
    }

    // ===== CSV Upload =====
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const result = [];

      // Skip first line (header row)
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        // Split by comma, handle quoted fields
        const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));

        if (parts.length >= 2) {
          result.push({
            id: parts[0],
            name: parts[1]
          });
        }
      }

      return result;
    }

    csvUpload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        // Read file as ArrayBuffer to detect encoding
        const arrayBuffer = await file.arrayBuffer();
        let text = null;

        // Try different encodings
        const encodings = ['UTF-8', 'Big5', 'GBK', 'UTF-16LE'];

        for (const encoding of encodings) {
          try {
            const decoder = new TextDecoder(encoding, { fatal: true });
            text = decoder.decode(arrayBuffer);

            // Check if decoded text looks valid (no replacement characters)
            if (!text.includes('\uFFFD') && text.trim().length > 0) {
              console.log(`Successfully decoded with ${encoding}`);
              break;
            }
          } catch (decodeError) {
            // Try next encoding
            continue;
          }
        }

        // Fallback to UTF-8 if all else fails
        if (!text || text.includes('\uFFFD')) {
          const decoder = new TextDecoder('UTF-8', { fatal: false });
          text = decoder.decode(arrayBuffer);
        }

        const data = parseCSV(text);

        if (data.length === 0) {
          alert('CSVæª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ç„¡æœ‰æ•ˆè³‡æ–™ã€‚è«‹ç¢ºèªæ ¼å¼ï¼šå“¡å·¥ç·¨è™Ÿ,å§“å');
          return;
        }

        saveParticipants(data);
        clearResultsUI();
        alert(`æˆåŠŸè¼‰å…¥ ${data.length} ä½åƒèˆ‡è€…ï¼`);
      } catch (err) {
        alert('è®€å–CSVæª”æ¡ˆå¤±æ•—ï¼š' + err.message);
      }

      // Reset input so same file can be uploaded again
      e.target.value = '';
    });

    btnClear.addEventListener('click', () => {
      if (isRunning) return;

      if (participants.length === 0) {
        alert('ç›®å‰æ²’æœ‰åƒèˆ‡è€…è³‡æ–™ã€‚');
        return;
      }

      if (confirm(`ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åƒèˆ‡è€…è³‡æ–™å—ï¼Ÿï¼ˆå…± ${participants.length} ä½ï¼‰`)) {
        clearParticipants();
        stopRolling();
        clearSphere();
        clearResultsUI();
        alert('å·²æ¸…é™¤æ‰€æœ‰åƒèˆ‡è€…è³‡æ–™ã€‚');
      }
    });

    // ===== Animation / Machine =====
    let balls = [];
    let rollingRAF = null;
    let isRunning = false;

    function clearSphere() {
      balls.forEach(b => b.remove());
      balls = [];
    }

    function makeBall(text, variant = "normal") {
      const d = document.createElement("div");
      d.className = "ball" + (variant === "gold" ? " gold" : "");
      d.textContent = String(text);
      d.style.fontSize = "10px";
      d.style.lineHeight = "1.2";
      d.style.wordBreak = "break-all";
      sphere.appendChild(d);
      return d;
    }

    function layoutBalls(count) {
      // Place balls randomly inside sphere initially
      const rect = sphere.getBoundingClientRect();
      const R = rect.width / 2;
      const pad = 28;
      const center = { x: R, y: R };

      clearSphere();

      // å¦‚æœæœ‰åƒèˆ‡è€…è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨åƒèˆ‡è€…å§“åï¼›å¦å‰‡ä½¿ç”¨åºè™Ÿ
      let ballTexts = [];
      if (participants.length > 0) {
        // éš¨æ©Ÿé¸æ“‡åƒèˆ‡è€…ï¼ˆæœ€å¤šå–å¾— count å€‹ï¼‰
        const shuffledParticipants = [...participants].sort(() => Math.random() - 0.5);
        ballTexts = shuffledParticipants.slice(0, count).map(p => p.name);
      } else {
        // å¦‚æœæ²’æœ‰åƒèˆ‡è€…ï¼Œä½¿ç”¨è£é£¾ç”¨çš„åºè™Ÿ
        ballTexts = Array.from({ length: count }, (_, i) => String((i % 99) + 1));
      }

      for (let i = 0; i < ballTexts.length; i++) {
        const text = ballTexts[i];
        const d = makeBall(text, i % 9 === 0 ? "gold" : "normal");

        const angle = Math.random() * Math.PI * 2;
        const r = (R - pad) * Math.sqrt(Math.random());
        const x = center.x + r * Math.cos(angle);
        const y = center.y + r * Math.sin(angle);

        d.dataset.x = x;
        d.dataset.y = y;
        d.dataset.vx = (Math.random() * 2 - 1) * 1.2;
        d.dataset.vy = (Math.random() * 2 - 1) * 1.2;

        d.style.transform = `translate(${x - 22}px, ${y - 22}px)`;
      }

      balls = Array.from(sphere.querySelectorAll(".ball"));
    }

    function rollStep() {
      const rect = sphere.getBoundingClientRect();
      const R = rect.width / 2;
      const pad = 26;
      const center = { x: R, y: R };

      // light "swirl" bias to feel like mixing
      const swirl = 0.06;

      for (const d of balls) {
        let x = parseFloat(d.dataset.x);
        let y = parseFloat(d.dataset.y);
        let vx = parseFloat(d.dataset.vx);
        let vy = parseFloat(d.dataset.vy);

        // swirl field around center
        const dx = x - center.x;
        const dy = y - center.y;
        vx += (-dy) * swirl / R;
        vy += (dx) * swirl / R;

        // move
        x += vx;
        y += vy;

        // bounce against circle boundary
        const dist = Math.sqrt((x - center.x) ** 2 + (y - center.y) ** 2);
        const maxDist = R - pad;

        if (dist > maxDist) {
          // reflect velocity
          const nx = (x - center.x) / dist;
          const ny = (y - center.y) / dist;
          // push back in
          x = center.x + nx * maxDist;
          y = center.y + ny * maxDist;

          const dot = vx * nx + vy * ny;
          vx = vx - 2 * dot * nx;
          vy = vy - 2 * dot * ny;

          // damping / random kick
          vx *= 0.92; vy *= 0.92;
          vx += (Math.random() * 2 - 1) * 0.12;
          vy += (Math.random() * 2 - 1) * 0.12;
        }

        // mild friction
        vx *= 0.995;
        vy *= 0.995;

        d.dataset.x = x; d.dataset.y = y;
        d.dataset.vx = vx; d.dataset.vy = vy;
        d.style.transform = `translate(${x - 22}px, ${y - 22}px)`;
      }

      rollingRAF = requestAnimationFrame(rollStep);
    }

    function startRolling() {
      cancelAnimationFrame(rollingRAF);
      layoutBalls(18);
      rollStep();
    }

    function stopRolling() {
      cancelAnimationFrame(rollingRAF);
      rollingRAF = null;
    }

    // ===== Visual FX =====
    function clearResultsUI() {
      const hint = participants.length === 0
        ? 'è«‹å…ˆä¸Šå‚³CSVæª”æ¡ˆã€‚'
        : 'å°šæœªé–‹å§‹ï¼Œè«‹æŒ‰ã€Œé–‹å§‹æŠ½çã€ã€‚';
      resultStrip.innerHTML = `<span class="hint">${hint}</span>`;
      bigNumber.innerHTML = "--";
      nowHint.textContent = "â€”";
    }

    function addResultPill(person) {
      const hint = resultStrip.querySelector(".hint");
      if (hint) hint.remove();

      const pill = document.createElement("div");
      pill.className = "num-pill";
      pill.innerHTML = `<div style="font-size:11px; opacity:0.8;">${person.id}</div><div style="font-size:15px; font-weight:1000;">${person.name}</div>`;
      resultStrip.appendChild(pill);
    }

    function setBigNumber(person) {
      bigNumber.classList.remove("pulse");
      // reflow to restart animation
      void bigNumber.offsetWidth;
      bigNumber.innerHTML = `<div style="font-size:12px; opacity:0.85;">${person.id}</div><div style="font-size:17px; font-weight:1000; margin-top:2px;">${person.name}</div>`;
      bigNumber.classList.add("pulse");
    }

    function sparkBurst(x, y, count = 14) {
      for (let i = 0; i < count; i++) {
        const s = document.createElement("div");
        s.className = "spark show";
        s.style.left = x + "px";
        s.style.top = y + "px";
        const dx = (Math.random() * 2 - 1) * 180 + "px";
        const dy = (Math.random() * 2 - 1) * 120 + "px";
        s.style.setProperty("--dx", dx);
        s.style.setProperty("--dy", dy);

        // alternate colors
        if (i % 3 === 0) s.style.background = "var(--accent)";
        else if (i % 3 === 1) s.style.background = "var(--pink)";
        else s.style.background = "var(--magenta)";

        stage.appendChild(s);
        setTimeout(() => s.remove(), 950);
      }
    }

    // ===== Draw Logic =====
    function validateMN() {
      const M = participants.length;
      let N = clampInt(elN.value, 1, 9999);
      if (N > M) N = M;

      elM.value = M;
      elN.value = N;
      return { M, N };
    }

    function sampleParticipants(N) {
      if (participants.length === 0) return [];
      const pool = [...participants];
      shuffle(pool);
      return pool.slice(0, N);
    }

    async function runDraw() {
      if (isRunning) return;

      if (participants.length === 0) {
        alert('è«‹å…ˆä¸Šå‚³CSVæª”æ¡ˆï¼');
        return;
      }

      isRunning = true;
      btnStart.disabled = true;
      btnReset.disabled = true;
      btnClear.disabled = true;

      const { M, N } = validateMN();

      clearResultsUI();
      statusText.textContent = `æ»¾å‹•ä¸­ï¼šæ­£åœ¨æ··çƒï¼ˆå…±${M}ä½åƒèˆ‡è€…ï¼Œå°‡æŠ½å‡º${N}ä½ï¼‰â€¦`;
      await SFX.resumeIfNeeded();

      // start rolling animation + whoosh
      startRolling();
      SFX.whoosh();

      // rolling duration
      await sleep(1600);

      // decide results
      const results = sampleParticipants(N);

      // reveal one by one
      statusText.textContent = "é–‹çä¸­ï¼šé€ä¸€æ­æ›‰ä¸­çè€…â€¦";
      for (let i = 0; i < results.length; i++) {
        const person = results[i];

        // small pause between numbers
        await sleep(550);

        // stop rolling briefly to emphasize reveal, then resume quickly
        stopRolling();
        await sleep(60);

        setBigNumber(person);
        addResultPill(person);
        nowHint.textContent = `ç¬¬ ${i + 1} ä½ / å…± ${results.length} ä½`;

        // fx: spark burst near big number box position
        const rect = bigNumber.getBoundingClientRect();
        const stageRect = stage.getBoundingClientRect();
        const cx = rect.left - stageRect.left + rect.width / 2;
        const cy = rect.top - stageRect.top + rect.height / 2;
        sparkBurst(cx, cy, 16);

        // sound: "ding"
        SFX.beep({ freq: 740 + i * 70, dur: 0.09, type: "sine", gain: 0.085 });
        setTimeout(() => SFX.beep({ freq: 990 + i * 40, dur: 0.06, type: "triangle", gain: 0.06 }), 80);

        // resume rolling lightly between reveals (keeps the "machine" alive)
        startRolling();
      }

      // finish
      stopRolling();
      statusText.textContent = `å®Œæˆï¼šå·²æŠ½å‡º ${N} ä½ä¸­çè€…ï¼ˆå¯å†æ¬¡æŠ½çï¼‰ã€‚`;
      nowHint.textContent = `å®Œæˆï¼ˆå…± ${N} ä½ï¼‰`;
      SFX.win();

      btnStart.disabled = false;
      btnReset.disabled = false;
      btnClear.disabled = false;
      isRunning = false;
    }

    // ===== Events =====
    btnStart.addEventListener("click", runDraw);

    btnReset.addEventListener("click", () => {
      if (isRunning) return;

      // åœæ­¢æ»¾å‹•ä¸¦æ¸…ç©ºçƒé«”
      stopRolling();
      clearSphere();

      // é‡ç½® N å›é è¨­å€¼ 1
      elN.value = 1;

      // æ¸…ç©ºçµæœé¡¯ç¤º
      clearResultsUI();

      // é‡æ–°é©—è­‰åƒæ•¸
      validateMN();

      // é‡æ–°ä½ˆç½®è£é£¾æ€§çƒé«”ï¼ˆç©ºé–’ç‹€æ…‹ï¼‰
      layoutBalls(14);

      // æ›´æ–°ç‹€æ…‹æ–‡å­—
      updateParticipantCount();
    });

    // Keep inputs sane
    elN.addEventListener("change", () => validateMN());

    // First paint
    loadParticipants();
    validateMN();
    clearResultsUI();
    // Decorative idle balls
    layoutBalls(14);
    rollStep();
    // slow down idle motion by reducing vx/vy
    setTimeout(() => {
      for (const d of balls) {
        d.dataset.vx = parseFloat(d.dataset.vx) * 0.35;
        d.dataset.vy = parseFloat(d.dataset.vy) * 0.35;
      }
      if (participants.length === 0) {
        statusText.textContent = "è«‹å…ˆä¸Šå‚³åŒ…å«ã€Œå“¡å·¥ç·¨è™Ÿã€å’Œã€Œå§“åã€çš„CSVæª”æ¡ˆã€‚";
      }
    }, 450);

    // Responsive: relayout on resize
    let resizeT = null;
    window.addEventListener("resize", () => {
      clearTimeout(resizeT);
      resizeT = setTimeout(() => {
        if (!isRunning) {
          layoutBalls(14);
        }
      }, 120);
    });
  </script>
</body>

</html>